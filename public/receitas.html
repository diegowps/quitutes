<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receitas - Quitutes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-5">
        <h1 class="mb-4">Receitas</h1>
        <button class="btn btn-primary mb-4" id="btn-add-receita">Adicionar Receita</button>

        <div id="receitas-lista" class="row">
            <!-- Receitas serão carregadas aqui -->
        </div>
    </div>

    <div id="modal-receita" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Receita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-receita">
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Título</label>
                            <input type="text" class="form-control" id="titulo" required>
                        </div>
                        <div class="mb-3"></div>
                            <label for="categoria" class="form-label">Categoria</label>
                            <select class="form-select" id="categoria" required>
                                <option value="doces">Doces</option>
                                <option value="salgados">Salgados</option>
                                <option value="bebidas">Bebidas</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="imagem" class="form-label">Imagem</label>
                            <input type="file" class="form-control" id="imagem" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricao"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="passos" class="form-label">Passos</label>
                            <textarea class="form-control" id="passos"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/navbar.html')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar o menu de navegação.');
                    }
                    return response.text();
                })
                .then(data => {
                    document.getElementById('navbar-container').innerHTML = data;
                })
                .catch(err => console.error('Erro ao carregar o menu de navegação:', err));

            const listaReceitas = document.getElementById('receitas-lista');
            const modalReceita = new bootstrap.Modal(document.getElementById('modal-receita'));
            const formReceita = document.getElementById('form-receita');

            function carregarReceitas() {
                fetch('/api/receitas')
                    .then(response => response.json())
                    .then(receitas => {
                        listaReceitas.innerHTML = '';
                        receitas.forEach(receita => {
                            const card = document.createElement('div');
                            card.className = 'col-md-4';
                            card.innerHTML = `
                                <div class="card mb-4">
                                    <img src="${receita.imagem}" class="card-img-top" alt="${receita.titulo}">
                                    <div class="card-body">
                                        <h5 class="card-title">${receita.titulo}</h5>
                                        <p class="card-text">${receita.descricao || ''}</p>
                                        <button class="btn btn-warning btn-sm" onclick="editarReceita(${receita.id})">Editar</button>
                                        <button class="btn btn-danger btn-sm" onclick="excluirReceita(${receita.id})">Excluir</button>
                                    </div>
                                </div>
                            `;
                            listaReceitas.appendChild(card);
                        });
                    });
            }

            formReceita.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData();
                
                formData.append('titulo', document.getElementById('titulo').value);
                formData.append('categoria', document.getElementById('categoria').value);
                formData.append('descricao', document.getElementById('descricao').value);
                formData.append('passos', document.getElementById('passos').value);
                
                const imagemInput = document.getElementById('imagem');
                if (imagemInput.files[0]) {
                    formData.append('imagem', imagemInput.files[0]);
                }

                fetch('/api/receitas', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Erro ao processar a receita');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    modalReceita.hide();
                    carregarReceitas();
                })
                .catch(err => {
                    console.error('Erro:', err);
                    alert('Erro ao salvar receita: ' + err.message);
                });
            });

            document.getElementById('btn-add-receita').addEventListener('click', () => {
                formReceita.reset();
                modalReceita.show();
            });

            carregarReceitas();
        });

        function editarReceita(id) {
            fetch(`/api/receitas/${id}`)
                .then(response => response.json())
                .then(receita => {
                    document.getElementById('titulo').value = receita.titulo;
                    document.getElementById('categoria').value = receita.categoria;
                    document.getElementById('descricao').value = receita.descricao || '';
                    document.getElementById('passos').value = receita.passos || '';
                    // Não preenche o campo de imagem (file) por segurança
                    document.getElementById('form-receita').onsubmit = function(e) {
                        e.preventDefault();
                        const formData = new FormData(document.getElementById('form-receita'));
                        fetch(`/api/receitas/${id}`, {
                            method: 'PUT',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(() => {
                            bootstrap.Modal.getInstance(document.getElementById('modal-receita')).hide();
                            location.reload();
                        });
                    };
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('modal-receita')).show();
                });
        }
    </script>
</body>
</html>
